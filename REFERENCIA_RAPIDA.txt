================================================================================
REFERENCIA R√ÅPIDA - M√âTODOS Y FUNCIONES DEL SISTEMA POS
================================================================================

## CLASE: DBConnection.cs
Ubicaci√≥n: ProyectoEleventa/Data/DBConnection.cs

### M√©todos P√∫blicos:

üìå GetConnection()
   Retorna: SqlConnection
   Uso: Crear nueva conexi√≥n a base de datos
   Ejemplo: using(SqlConnection conn = DBConnection.GetConnection()) { ... }

üìå ExecuteQuery(string query, params SqlParameter[] parameters)
   Retorna: DataTable
   Uso: Ejecutar SELECT
   Ejemplo: 
      string sql = "SELECT * FROM productos WHERE nombre LIKE @nombre";
      DataTable dt = DBConnection.ExecuteQuery(sql, 
         new SqlParameter("@nombre", "%Laptop%"));

üìå ExecuteNonQuery(string query, params SqlParameter[] parameters)
   Retorna: int (n√∫mero de filas afectadas)
   Uso: Ejecutar INSERT, UPDATE, DELETE
   Ejemplo:
      string sql = "UPDATE productos SET existencia = existencia - @qty WHERE id = @id";
      int filas = DBConnection.ExecuteNonQuery(sql,
         new SqlParameter("@qty", 5),
         new SqlParameter("@id", 10));

üìå ExecuteScalar(string query, params SqlParameter[] parameters)
   Retorna: object (valor √∫nico)
   Uso: Obtener un solo valor (COUNT, SUM, MAX, etc)
   Ejemplo:
      object result = DBConnection.ExecuteScalar(
         "SELECT COUNT(*) FROM productos WHERE estado = 1");
      int cantidad = Convert.ToInt32(result);

üìå ExecuteTransaction(Action<SqlConnection, SqlTransaction> action)
   Retorna: bool (true si exitoso, false si error)
   Uso: Ejecutar m√∫ltiples operaciones atomicamente
   Ejemplo:
      bool exito = DBConnection.ExecuteTransaction((conn, trans) => {
         // INSERT, UPDATE, DELETE aqu√≠
         SqlCommand cmd = new SqlCommand("INSERT INTO ventas...", conn, trans);
         cmd.ExecuteNonQuery();
      });

================================================================================
## CLASE: ProductoDAL.cs
Ubicaci√≥n: ProyectoEleventa/Data/ProductoDAL.cs

### M√©todos P√∫blicos:

üìå BuscarPorCodigo(string codigo) ‚Üí DataRow
   Retorna: Fila del producto o null
   SQL: SELECT id_producto, nombre, precio_venta, existencia WHERE codigo_barras = @codigo
   Uso: Escaneo de c√≥digo de barras en POS
   Ejemplo:
      DataRow producto = ProductoDAL.BuscarPorCodigo("7891234567890");
      if (producto != null)
         decimal precio = Convert.ToDecimal(producto["precio_venta"]);

üìå BuscarPorNombre(string nombre) ‚Üí DataTable
   Retorna: DataTable con productos que coinciden
   SQL: SELECT ... WHERE nombre LIKE @nombre AND estado = 1
   Uso: B√∫squeda de productos en BusquedaProductos
   Ejemplo:
      DataTable dt = ProductoDAL.BuscarPorNombre("Laptop");
      dgv.DataSource = dt;

üìå ObtenerPorId(int idProducto) ‚Üí DataRow
   Retorna: Fila del producto o null
   SQL: SELECT ... WHERE id_producto = @id AND estado = 1
   Uso: Obtener detalles de un producto espec√≠fico
   Ejemplo:
      DataRow producto = ProductoDAL.ObtenerPorId(5);

üìå ObtenerTodos() ‚Üí DataTable
   Retorna: DataTable con todos los productos activos
   SQL: SELECT ... WHERE estado = 1 ORDER BY nombre
   Uso: Cargar lista completa de productos
   Ejemplo:
      DataTable dt = ProductoDAL.ObtenerTodos();

üìå ObtenerExistencia(int idProducto) ‚Üí decimal
   Retorna: Cantidad disponible en stock
   SQL: SELECT existencia WHERE id_producto = @id
   Uso: Validar si hay stock disponible
   Ejemplo:
      decimal stock = ProductoDAL.ObtenerExistencia(10);
      if (cantidad > stock) MessageBox.Show("Stock insuficiente");

üìå ActualizarExistencia(int idProducto, decimal cantidad, SqlConnection conn, SqlTransaction trans) ‚Üí int
   Retorna: Filas afectadas (1 = √©xito, 0 = fracaso)
   SQL: UPDATE productos SET existencia = existencia - @cantidad WHERE id = @id
   Uso: SOLO DENTRO DE TRANSACCI√ìN (en RealizarCobro)
   Ejemplo: (Ver VentaDAL.RegistrarVenta)
   NOTA: Necesita SqlConnection y SqlTransaction activos

üìå Existe(int idProducto) ‚Üí bool
   Retorna: true si existe y est√° activo, false si no
   SQL: SELECT COUNT(*) WHERE id = @id AND estado = 1
   Uso: Verificar si un producto es v√°lido
   Ejemplo:
      if (ProductoDAL.Existe(10))
         MessageBox.Show("Producto existe");

================================================================================
## CLASE: ClienteDAL.cs
Ubicaci√≥n: ProyectoEleventa/Data/ClienteDAL.cs

### M√©todos P√∫blicos:

üìå ObtenerTodos() ‚Üí DataTable
   Retorna: DataTable con todos los clientes activos
   SQL: SELECT id_cliente, nombre, limite_credito, credito_usado WHERE estado = 1
   Uso: Cargar ComboBox cmbClientes
   Ejemplo:
      DataTable dt = ClienteDAL.ObtenerTodos();
      cmbClientes.DataSource = dt;

üìå ObtenerPorId(int idCliente) ‚Üí DataRow
   Retorna: Fila del cliente o null
   SQL: SELECT ... WHERE id_cliente = @id AND estado = 1
   Uso: Obtener detalles de un cliente espec√≠fico
   Ejemplo:
      DataRow cliente = ClienteDAL.ObtenerPorId(5);
      string nombre = cliente["nombre"].ToString();

üìå ObtenerCreditoDisponible(int idCliente) ‚Üí decimal
   Retorna: Saldo de cr√©dito disponible
   C√°lculo: limite_credito - credito_usado
   Uso: Validar si puede hacer compra a cr√©dito
   Ejemplo:
      decimal creditoDisp = ClienteDAL.ObtenerCreditoDisponible(3);
      if (totalVenta > creditoDisp)
         MessageBox.Show("Cr√©dito insuficiente");

üìå BuscarPorNombre(string nombre) ‚Üí DataTable
   Retorna: DataTable con clientes que coinciden
   SQL: SELECT ... WHERE nombre LIKE @nombre AND estado = 1
   Uso: Autocompletado o b√∫squeda de cliente
   Ejemplo:
      DataTable dt = ClienteDAL.BuscarPorNombre("EMPRESA");

üìå ActualizarCreditoUsado(int idCliente, decimal monto, SqlConnection conn, SqlTransaction trans) ‚Üí int
   Retorna: Filas afectadas (1 = √©xito)
   SQL: UPDATE clientes SET credito_usado = credito_usado + @monto WHERE id = @id
   Uso: SOLO DENTRO DE TRANSACCI√ìN (en VentaDAL.RegistrarVenta si es cr√©dito)
   Ejemplo: (Ver VentaDAL.RegistrarVenta)
   NOTA: Necesita SqlConnection y SqlTransaction activos

üìå ObtenerClientePorDefecto() ‚Üí int
   Retorna: ID del cliente por defecto (MOSTRADOR o CONSUMIDOR FINAL)
   SQL: SELECT TOP 1 id_cliente WHERE nombre = 'MOSTRADOR' OR 'CONSUMIDOR FINAL'
   Uso: Si no se selecciona cliente expl√≠citamente
   Ejemplo:
      int idCliente = ClienteDAL.ObtenerClientePorDefecto();

================================================================================
## CLASE: VentaDAL.cs
Ubicaci√≥n: ProyectoEleventa/Data/VentaDAL.cs

### M√©todos P√∫blicos:

üìå RegistrarVenta(int idCliente, decimal subtotal, decimal impuesto, decimal descuento, 
                  decimal total, string metodoPago, int idUsuario, 
                  DataGridView dgvTicket, SqlConnection conn, SqlTransaction trans) ‚Üí int

   Retorna: ID de la venta creada
   
   ¬øQU√â HACE?
   1. INSERT en tabla VENTAS ‚Üí retorna id_venta
   2. POR CADA FILA en dgvTicket:
      - INSERT en DETALLE_VENTAS
      - UPDATE en PRODUCTOS (restar existencia)
      - INSERT en MOVIMIENTOS_INVENTARIO
   3. SI metodoPago == "Cr√©dito": UPDATE CLIENTES (agregar a cr√©dito_usado)
   
   Uso: SOLO DENTRO DE DBConnection.ExecuteTransaction()
   
   Ejemplo (ver FormularioVentas.RealizarCobro()):
      bool exito = DBConnection.ExecuteTransaction((conn, trans) => {
         int idVenta = VentaDAL.RegistrarVenta(
            idCliente: 5,
            subtotal: 1000,
            impuesto: 160,
            descuento: 50,
            total: 1110,
            metodoPago: "Efectivo",
            idUsuario: 1,
            dgvTicket: dgvTicket,
            conn: conn,
            trans: trans
         );
      });
   
   IMPORTANTE: Pasar SqlConnection y SqlTransaction activos
              Si algo falla ‚Üí ROLLBACK autom√°tico

üìå ObtenerVentasPorPeriodo(DateTime desde, DateTime hasta) ‚Üí DataTable
   Retorna: Todas las ventas en rango de fechas
   SQL: SELECT ... FROM ventas WHERE fecha_venta BETWEEN @desde AND @hasta
   Uso: Reportes, historial de ventas
   Ejemplo:
      DataTable dt = VentaDAL.ObtenerVentasPorPeriodo(
         new DateTime(2024, 1, 1),
         new DateTime(2024, 1, 31)
      );

üìå ObtenerDetalleVenta(int idVenta) ‚Üí DataTable
   Retorna: L√≠neas de un venta espec√≠fica
   SQL: SELECT ... FROM detalle_ventas WHERE id_venta = @idVenta
   Uso: Ver qu√© productos se vendieron en una venta
   Ejemplo:
      DataTable dt = VentaDAL.ObtenerDetalleVenta(123);

üìå ObtenerTotalVentasPorPeriodo(DateTime desde, DateTime hasta) ‚Üí decimal
   Retorna: Suma de todos los totales en el per√≠odo
   SQL: SELECT SUM(total) FROM ventas WHERE fecha_venta BETWEEN @desde AND @hasta
   Uso: Reporte de ventas totales
   Ejemplo:
      decimal total = VentaDAL.ObtenerTotalVentasPorPeriodo(
         DateTime.Now.AddDays(-30), DateTime.Now
      );

================================================================================
## M√âTODOS EN FormularioVentas.cs
Ubicaci√≥n: ProyectoEleventa/FormularioVentas.cs

### M√©todos Principales (FLUJO DEL POS):

üìå AgregarProductoAlTicket()
   Qu√© hace: Busca producto, valida stock, calcula subtotal, agrega a DataGridView
   Pasos:
      1. Lee txtCodigoProducto
      2. Busca con ProductoDAL.BuscarPorCodigo()
      3. Valida: c√≥digo no vac√≠o, producto existe, cantidad > 0, stock suficiente
      4. Calcula: importeLinea = cantidad √ó precio; subtotal = importe - descuento
      5. Inserta fila en dgvTicket
      6. Recalcula totales
      7. Limpia campos y enfoca c√≥digo

üìå EliminarProductoDelTicket()
   Qu√© hace: Borra fila seleccionada del DataGridView y recalcula totales
   Validaci√≥n: Verifica que hay fila seleccionada

üìå RecalcularTotales()
   Qu√© hace: Suma todos los subtotales, calcula impuesto y total
   F√≥rmula:
      subtotalGeneral = SUM(subtotal de todas las filas) - descuentoGlobal
      impuesto = subtotalGeneral √ó 0.16
      total = subtotalGeneral + impuesto
   Actualiza: lblSubtotal, lblImpuesto, lblTotal

üìå RealizarCobro() ‚Üê M√âTODO CR√çTICO
   Qu√© hace: Ejecuta transacci√≥n completa de venta
   Pasos:
      1. Validar: hay productos, cliente, m√©todo de pago
      2. Si cr√©dito: validar l√≠mite disponible
      3. Ejecutar DBConnection.ExecuteTransaction()
      4. Dentro: llamar VentaDAL.RegistrarVenta()
      5. Si OK: mensaje √©xito, limpiar ticket
      6. Si error: ROLLBACK autom√°tico, mostrar error

üìå CancelarVenta()
   Qu√© hace: Limpia todo sin guardar
   Pregunta: ¬øEst√° seguro de cancelar?

üìå LimpiarTicket()
   Qu√© hace: Limpia DataGridView, campos de producto, totales
   Usado: Despu√©s de cobrar exitoso, al cancelar

üìå LimpiarCamposProducto()
   Qu√© hace: Limpia txtCodigoProducto, txtNombreProducto, txtPrecio, nudCantidad
   Usado: Despu√©s de agregar cada producto

üìå EnfocarCodigoProducto()
   Qu√© hace: Pone foco en txtCodigoProducto y lo selecciona
   Usado: Para que usuario pueda escanear inmediatamente

### M√©todos de Utilidad:

üìå ObtenerDataGridViewTicket() ‚Üí DataGridView
   Retorna: El DataGridView principal del ticket
   B√∫squeda: Encuentra control que contiene "dgv" en el nombre

üìå ObtenerTextBox(string nombreParcial) ‚Üí TextBox
   Retorna: TextBox que contiene nombreParcial en el nombre
   Ejemplo: ObtenerTextBox("Codigo") ‚Üí encuentra txtCodigoProducto

üìå ObtenerNumericUpDown(string nombreParcial) ‚Üí NumericUpDown
   Igual que ObtenerTextBox pero para NumericUpDown

üìå ObtenerLabel(string nombreParcial) ‚Üí Label
   Igual que ObtenerTextBox pero para Label

### M√©todos de Formularios Secundarios:

üìå AbrirBusquedaProductos()
üìå AbrirINSVarios()
üìå AbrirProductoComun()
üìå AbrirEntradasEfectivo()
üìå AbrirSalidasEfectivo()
üìå AbrirVerificador()

================================================================================
## PATRONES Y MEJORES PR√ÅCTICAS IMPLEMENTADAS
================================================================================

1. USO DE PAR√ÅMETROS SQL (previene SQL injection)
   ‚ùå MALO: "WHERE codigo = '" + codigo + "'"
   ‚úÖ BIEN: "WHERE codigo = @codigo" 
           con new SqlParameter("@codigo", codigo)

2. MANEJO DE TRANSACCIONES (atomicidad)
   DBConnection.ExecuteTransaction((conn, trans) => {
      // M√∫ltiples operaciones que se hacen juntas o NO se hacen
      // Si algo falla ‚Üí ROLLBACK autom√°tico
   });

3. B√öSQUEDA RECURSIVA DE CONTROLES
   // En lugar de asumir nombres, buscar din√°micamente
   foreach (Control control in Controls)
       if (control is DataGridView && control.Name.Contains("dgv"))
           { ... }

4. SEPARACI√ìN DE CAPAS
   - FormularioVentas (UI) ‚Üí NO accede directamente a base de datos
   - ProductoDAL, ClienteDAL, VentaDAL (Data) ‚Üí M√©todos reutilizables
   - DBConnection (Acceso) ‚Üí Conexi√≥n centralizada

5. VALIDACIONES ANTES DE TRANSACCI√ìN
   // Validar ANTES de entrar en transacci√≥n
   if (cantidad > stock) {
      MessageBox.Show("Error");
      return;
   }
   // Luego s√≠ hacer transacci√≥n

================================================================================
## CONSTANTES DEFINIDAS
================================================================================

FormularioVentas.cs:
   const decimal IMPUESTO = 0.16m;  // 16% IVA
   int _idUsuario = 1;              // Usuario por defecto (cambiar en login)

DBConnection.cs:
   Cadena de conexi√≥n: "Server=localhost;Database=sistema_ventas;..."
   Cambiar seg√∫n tu servidor SQL

================================================================================
## VALORES POR DEFECTO
================================================================================

M√©todo de pago: "Efectivo"
Cliente: "MOSTRADOR" (id de cliente por defecto)
Cantidad inicial: 1 (NumericUpDown nudCantidad)
Descuento inicial: 0

================================================================================
## MENSAJES AL USUARIO
================================================================================

‚úì √âXITO:
  - "¬°Venta registrada exitosamente!"

‚ö†Ô∏è ADVERTENCIA:
  - "Ingrese c√≥digo de barras"
  - "Cantidad debe ser mayor a 0"
  - "Seleccione una fila para eliminar"
  - "El ticket est√° vac√≠o"
  - "Seleccione un producto"

‚ùå ERROR:
  - "Producto no encontrado"
  - "Stock insuficiente. Disponible: X"
  - "Cr√©dito insuficiente. Disponible: $X"

‚ùì CONFIRMACI√ìN:
  - "¬øEst√° seguro de cancelar la venta?"

================================================================================
¬°FIN DE REFERENCIA R√ÅPIDA!
================================================================================
